<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ZenKensa - AI Surface Inspection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .health-circle { transition: stroke-dashoffset 0.5s ease; }
        
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        .health-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .health-circle {
                width: 150px;
                height: 150px;
            }
            
            .health-circle svg {
                width: 150px !important;
                height: 150px !important;
            }
            
            #healthText {
                font-size: 2rem !important;
            }
            
            .bg-white.p-6 {
                padding: 1rem !important;
            }
            
            .bg-white.p-8 {
                padding: 1.5rem !important;
            }
        }
        
        .health-circle.pass {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }
        
        .health-circle.fail {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
        
        .scanning {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans">
    <div class="max-w-4xl mx-auto py-10 px-4">
        <h1 class="text-3xl font-bold text-slate-800 mb-8 text-center">ZENKENSA - AI Ë°®Èù¢Ê§úÊüª„Ç∑„Çπ„ÉÜ„É†</h1>
        
        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ê§úÊüªÂì°Âêç (Inspector Name)</label>
                    <input type="text" id="inspectorName" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ê§úÊüªÂì°Âêç„ÇíÂÖ•Âäõ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">„Éê„ÉÉ„ÉÅID (Batch ID)</label>
                    <input type="text" id="batchId" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="„Éê„ÉÉ„ÉÅID„ÇíÂÖ•Âäõ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ë£ΩÂìÅË™¨Êòé (Product Description)</label>
                    <input type="text" id="productDescription" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ë£ΩÂìÅË™¨Êòé„ÇíÂÖ•Âäõ">
                </div>
            </div>
            <input type="file" id="fileInput" class="hidden" accept="image/*" capture="environment">
            <button onclick="document.getElementById('fileInput').click()" class="w-full py-6 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition text-lg">
                üì∑ ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ (Upload Image)
            </button>
        </div>
        
        <div id="resultSection" class="hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center">
                    <h3 class="text-lg font-semibold text-slate-600 mb-4">ÂÅ•ÂÖ®ÊÄß„Çπ„Ç≥„Ç¢ (Health Score)</h3>
                    <div class="relative w-48 h-48">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="8" />
                            <circle id="healthProgress" cx="50" cy="50" r="45" fill="none" stroke="#ef4444" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" class="health-circle" />
                        </svg>
                        <div id="healthText" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-slate-800">0%</div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-600 mb-4">Ê§úÊüªÁµ±Ë®à (Inspection Stats)</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="text-slate-500">Âà§ÂÆö (Status)</span>
                            <span id="statusText" class="font-bold text-red-600">-</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="text-slate-500">Ê¨†Èô•Êï∞ (Defects)</span>
                            <span id="defectCount" class="font-bold text-slate-800">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">Ê¨†Èô•„Çπ„Ç≥„Ç¢ (Defect Score)</span>
                            <span id="defectScore" class="font-bold text-slate-800">0%</span>
                        </div>
                    </div>
                    <a id="downloadBtn" href="#" class="mt-6 block w-full py-4 bg-slate-800 text-white text-center rounded-lg hover:bg-slate-900 transition">
                        Â†±ÂëäÊõ∏„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ (Download PDF)
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Inspection History Section -->
        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mt-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Ê§úÊüªÂ±•Ê≠¥ (Inspection History)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-6 py-3">ID</th>
                            <th class="px-6 py-3">Êó•ÊôÇ (Date/Time)</th>
                            <th class="px-6 py-3">Ê§úÊüªÂì° (Inspector)</th>
                            <th class="px-6 py-3">„Éê„ÉÉ„ÉÅ (Batch)</th>
                            <th class="px-6 py-3">Áä∂ÊÖã (Status)</th>
                            <th class="px-6 py-3">„Çπ„Ç≥„Ç¢ (Score)</th>
                            <th class="px-6 py-3">Ê¨†Èô•Êï∞ (Defects)</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-slate-200">
                        <!-- History records will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="overlay" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-4"></div>
            <p class="text-slate-600 font-medium">„Çπ„Ç≠„É£„É≥‰∏≠ (Scanning...)</p>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const overlay = document.getElementById('overlay');
    
    // Load history on page load
    loadHistory();
    
    // Function to load inspection history
    async function loadHistory() {
        try {
            const response = await fetch('/history');
            const result = await response.json();
            
            if (result.status === 'success') {
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '';
                
                result.data.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = record.status === 'Fail' ? 'bg-red-50' : 'bg-green-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium">${record.id}</td>
                        <td class="px-6 py-4">${record.timestamp}</td>
                        <td class="px-6 py-4">${record.inspector}</td>
                        <td class="px-6 py-4">${record.batch}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                record.status === 'Fail' 
                                ? 'bg-red-100 text-red-800' 
                                : 'bg-green-100 text-green-800'
                            }">
                                ${record.status}
                            </span>
                        </td>
                        <td class="px-6 py-4">${record.score}%</td>
                        <td class="px-6 py-4">${record.defects}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        } catch (err) {
            console.error('Error loading history:', err);
        }
    }
    
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        overlay.classList.remove('hidden');
        
        try {
            const response = await fetch('/predict', { method: 'POST', body: formData });
            const result = await response.json();
            
            if (result.status === 'success') {
                const data = result.data;
                // Use health_score sent by backend
                const healthScore = data.health_score;
                
                document.getElementById('resultSection').classList.remove('hidden');
                document.getElementById('statusText').textContent = data.status === 'Fail' ? '‰∏çÂêàÊ†º (Fail)' : 'ÂêàÊ†º (Pass)';
                document.getElementById('defectCount').textContent = data.number_of_defects;
                document.getElementById('defectScore').textContent = data.defect_score + '%';
                document.getElementById('healthText').textContent = healthScore + '%';
                
                // Update Progress Circle - Green for health_score >= 90 AND defects <= 5, Red for fail
                const offset = 283 - (283 * healthScore / 100);
                document.getElementById('healthProgress').style.strokeDashoffset = offset;
                document.getElementById('healthProgress').style.stroke = (healthScore >= 90 && data.number_of_defects <= 5) ? '#10b981' : '#ef4444';
                
                // Sync Download Link with backend - include health_score
                const inspectorName = document.getElementById('inspectorName').value || 'Ê§úÊüªÂì°';
                const batchId = document.getElementById('batchId').value || 'BATCH-001';
                const productDescription = document.getElementById('productDescription').value || 'Ë£ΩÂìÅ';
                document.getElementById('downloadBtn').href = `/generate-report?status=${data.status}&defect_score=${data.defect_score}&number_of_defects=${data.number_of_defects}&health_score=${healthScore}&inspector_name=${encodeURIComponent(inspectorName)}&batch_id=${encodeURIComponent(batchId)}&product_description=${encodeURIComponent(productDescription)}`;
                
                // Auto-refresh history after successful scan
                loadHistory();
            }
        } catch (err) {
            alert('Error processing image: ' + err.message);
        } finally {
            overlay.classList.add('hidden');
        }
    });
</script>
</body>
</html>
