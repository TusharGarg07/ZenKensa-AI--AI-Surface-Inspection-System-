<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ZenKensa - AI Surface Inspection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        .health-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .health-circle.pass {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }
        
        .health-circle.fail {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
        }
        
        .health-circle.invalid {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.3);
        }
        
        .health-circle.uncertain {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }
        
        .scanning {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        
        .status-pass { color: #059669; }
        .status-fail { color: #dc2626; }
        .status-invalid { color: #d97706; }
        .status-uncertain { color: #7c3aed; }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .health-circle {
                width: 150px;
                height: 150px;
            }
            
            #healthText {
                font-size: 2rem !important;
            }
            
            .bg-white.p-6 {
                padding: 1rem !important;
            }
            
            .bg-white.p-8 {
                padding: 1.5rem !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans">
    <div class="max-w-4xl mx-auto py-10 px-4">
        <h1 class="text-3xl font-bold text-slate-800 mb-8 text-center">ZENKENSA - AI Ë°®Èù¢Ê§úÊüª„Ç∑„Çπ„ÉÜ„É†</h1>
        
        <!-- Upload Section -->
        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ê§úÊüªÂì°Âêç (Inspector Name)</label>
                    <input type="text" id="inspectorName" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ê§úÊüªÂì°Âêç„ÇíÂÖ•Âäõ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">„Éê„ÉÉ„ÉÅID (Batch ID)</label>
                    <input type="text" id="batchId" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="„Éê„ÉÉ„ÉÅID„ÇíÂÖ•Âäõ">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Ë£ΩÂìÅË™¨Êòé (Product Description)</label>
                    <input type="text" id="productDescription" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ë£ΩÂìÅË™¨Êòé„ÇíÂÖ•Âäõ">
                </div>
            </div>
            
            <!-- Drag and Drop Upload Area -->
            <div id="uploadArea" class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:border-indigo-400 transition-colors cursor-pointer">
                <input type="file" id="fileInput" class="hidden" accept="image/*" capture="environment">
                <div id="uploadContent">
                    <div class="text-4xl mb-4">üì∑</div>
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">Upload close-up industrial metal surface image</h3>
                    <p class="text-slate-500 text-sm mb-4">Drag and drop image here or click to browse</p>
                    <button id="uploadBtn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Choose Image
                    </button>
                </div>
                <div id="loadingContent" class="hidden">
                    <div class="spinner mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold text-slate-700">Analyzing surface...</h3>
                    <p class="text-slate-500 text-sm">Please wait while we inspect your image</p>
                </div>
            </div>
        </div>
        
        <!-- Result Section -->
        <div id="resultSection" class="hidden space-y-8">
            <!-- Status Card -->
            <div id="statusCard" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-slate-600">Inspection Result</h3>
                    <span id="resultBadge" class="px-4 py-2 rounded-full text-white font-bold"></span>
                </div>
                <div id="explanationText" class="text-slate-600 mb-4"></div>
                <div id="warningText" class="text-amber-600 text-sm hidden"></div>
            </div>
            
            <!-- Detailed Results -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center">
                    <h3 class="text-lg font-semibold text-slate-600 mb-4">Health Score</h3>
                    <div id="healthCircle" class="health-circle">
                        <div id="healthText" class="text-3xl font-bold text-white">0%</div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-600 mb-4">Inspection Metrics</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between border-b pb-2">
                            <span class="text-slate-500">Metal Validation</span>
                            <span id="metalScore" class="font-bold text-slate-800">-</span>
                        </div>
                        <div class="flex justify-between border-b pb-2">
                            <span class="text-slate-500">Defect Confidence</span>
                            <span id="defectScore" class="font-bold text-slate-800">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">Inspection ID</span>
                            <span id="inspectionId" class="font-bold text-slate-800 text-sm">-</span>
                        </div>
                    </div>
                    <div class="mt-6 space-y-2">
                        <button id="downloadReportBtn" class="w-full py-3 bg-slate-800 text-white text-center rounded-lg hover:bg-slate-900 transition">
                            üìÑ Download Inspection Report
                        </button>
                        <button id="newInspectionBtn" class="w-full py-3 bg-indigo-600 text-white text-center rounded-lg hover:bg-indigo-700 transition">
                            üîÑ New Inspection
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Inspection History Section -->
        <div class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 mt-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Ê§úÊüªÂ±•Ê≠¥ (Inspection History)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                        <tr>
                            <th class="px-6 py-3">Timestamp</th>
                            <th class="px-6 py-3">Inspector</th>
                            <th class="px-6 py-3">Batch</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">Score</th>
                            <th class="px-6 py-3">Report</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- History rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentInspectionId = null;
        
        // Initialize upload area
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadContent = document.getElementById('uploadContent');
        const loadingContent = document.getElementById('loadingContent');
        const resultSection = document.getElementById('resultSection');
        
        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-active');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-active');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        // Click handlers
        uploadBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('click', (e) => {
            if (e.target.id !== 'uploadBtn') {
                fileInput.click();
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
        
        // New inspection button
        document.getElementById('newInspectionBtn').addEventListener('click', () => {
            resetForm();
        });
        
        // Download report button
        document.getElementById('downloadReportBtn').addEventListener('click', () => {
            if (currentInspectionId) {
                window.open(`/report/${currentInspectionId}`, '_blank');
            }
        });
        
        function handleFileUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }
            
            // Show loading state
            uploadContent.classList.add('hidden');
            loadingContent.classList.remove('hidden');
            uploadArea.classList.add('pointer-events-none', 'opacity-50');
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            // Send to API
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Inspection failed. Please try again.');
                resetForm();
            });
        }
        
        function displayResults(data) {
            // Hide loading, show results
            uploadContent.classList.remove('hidden');
            loadingContent.classList.add('hidden');
            uploadArea.classList.remove('pointer-events-none', 'opacity-50');
            resultSection.classList.remove('hidden');
            
            // Store inspection ID
            currentInspectionId = data.inspection_id || generateInspectionId();
            
            // Update status card
            const resultBadge = document.getElementById('resultBadge');
            const explanationText = document.getElementById('explanationText');
            const warningText = document.getElementById('warningText');
            const healthCircle = document.getElementById('healthCircle');
            const healthText = document.getElementById('healthText');
            
            // Reset classes
            healthCircle.className = 'health-circle';
            resultBadge.className = 'px-4 py-2 rounded-full text-white font-bold';
            
            // Handle different statuses
            if (data.status === 'INVALID_INPUT') {
                resultBadge.textContent = 'INVALID INPUT';
                resultBadge.classList.add('bg-amber-500');
                healthCircle.classList.add('invalid');
                explanationText.textContent = data.message || 'Image does not resemble an inspectable industrial metal surface.';
                warningText.textContent = 'Please upload a clear industrial metal surface image for inspection.';
                warningText.classList.remove('hidden');
                healthText.textContent = 'N/A';
                
                // Hide defect-related metrics
                document.getElementById('defectScore').textContent = 'N/A';
                document.getElementById('metalScore').textContent = (data.metal_validation_score * 100).toFixed(1) + '%';
                
            } else if (data.status === 'UNCERTAIN') {
                resultBadge.textContent = 'UNCERTAIN';
                resultBadge.classList.add('bg-purple-500');
                healthCircle.classList.add('uncertain');
                explanationText.textContent = data.message || 'Surface unclear. Please retake image with better lighting.';
                warningText.textContent = 'The surface could not be clearly identified. Please ensure proper lighting and focus.';
                warningText.classList.remove('hidden');
                healthText.textContent = 'N/A';
                
                document.getElementById('metalScore').textContent = (data.metal_validation_score * 100).toFixed(1) + '%';
                document.getElementById('defectScore').textContent = (data.defect_score * 100).toFixed(1) + '%';
                
            } else {
                // Valid inspection (PASS/FAIL)
                resultBadge.textContent = data.status;
                explanationText.textContent = data.explanation || '';
                warningText.classList.add('hidden');
                
                if (data.status === 'PASS') {
                    resultBadge.classList.add('bg-green-500');
                    healthCircle.classList.add('pass');
                    explanationText.textContent = 'Surface appears clean with no significant defect patterns.';
                } else {
                    resultBadge.classList.add('bg-red-500');
                    healthCircle.classList.add('fail');
                    explanationText.textContent = 'Surface shows defect patterns exceeding acceptable threshold.';
                }
                
                // Update scores
                healthText.textContent = Math.round(data.health_score) + '%';
                document.getElementById('metalScore').textContent = (data.metal_validation_score * 100).toFixed(1) + '%';
                document.getElementById('defectScore').textContent = (data.defect_score * 100).toFixed(1) + '%';
            }
            
            // Update inspection ID
            document.getElementById('inspectionId').textContent = currentInspectionId;
            
            // Load history
            loadInspectionHistory();
        }
        
        function resetForm() {
            // Reset upload area
            uploadContent.classList.remove('hidden');
            loadingContent.classList.add('hidden');
            uploadArea.classList.remove('pointer-events-none', 'opacity-50');
            resultSection.classList.add('hidden');
            
            // Reset file input
            fileInput.value = '';
            currentInspectionId = null;
        }
        
        function generateInspectionId() {
            return 'INS-' + Date.now().toString(36).toUpperCase();
        }
        
        function loadInspectionHistory() {
            // This would typically fetch from an API endpoint
            // For now, we'll keep the existing table empty
            const tbody = document.getElementById('historyTableBody');
            // tbody.innerHTML = ''; // Clear existing history
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInspectionHistory();
        });
    </script>
</body>
</html>
