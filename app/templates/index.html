<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ZenKensa - AI Surface Inspection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Japanese Industrial UX Principles */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #F7F8FA; /* ‰ΩôÁôΩ - Generous whitespace feel */
        }
        
        /* Industrial Color Palette - Muted, Trust-focused */
        :root {
            --color-primary: #1E3A8A; /* Deep industrial blue */
            --color-primary-hover: #1E40AF;
            --color-pass: #059669; /* Muted green */
            --color-fail: #DC2626; /* Muted red */
            --color-invalid: #D97706; /* Amber */
            --color-uncertain: #6B7280; /* Soft gray */
            --color-border: #E5E7EB;
            --color-text-primary: #1F2937;
            --color-text-secondary: #6B7280;
            --color-background: #FFFFFF;
            --color-surface: #F9FAFB;
        }
        
        /* Health Score Visualization - Industrial Style */
        .health-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s ease; /* Subtle transition only */
            border: 8px solid var(--color-border);
            background: var(--color-background);
        }
        
        .health-circle.pass {
            border-color: var(--color-pass);
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
        }
        
        .health-circle.fail {
            border-color: var(--color-fail);
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
        }
        
        .health-circle.invalid {
            border-color: var(--color-invalid);
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
        }
        
        .health-circle.uncertain {
            border-color: var(--color-uncertain);
            background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
        }
        
        .health-circle .score-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }
        
        .health-circle .score-label {
            position: absolute;
            bottom: -30px;
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            font-weight: 500;
        }
        
        .health-circle .responsibility-note {
            position: absolute;
            top: -25px;
            font-size: 0.625rem;
            color: var(--color-text-secondary);
            font-weight: 400;
            text-align: center;
            width: 100%;
        }
        
        /* Status Badges - Industrial, Clear */
        .status-badge {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            border: 2px solid;
        }
        
        .status-badge.pass {
            background-color: #ECFDF5;
            color: var(--color-pass);
            border-color: var(--color-pass);
        }
        
        .status-badge.fail {
            background-color: #FEF2F2;
            color: var(--color-fail);
            border-color: var(--color-fail);
        }
        
        .status-badge.invalid {
            background-color: #FFFBEB;
            color: var(--color-invalid);
            border-color: var(--color-invalid);
        }
        
        .status-badge.uncertain {
            background-color: #F9FAFB;
            color: var(--color-uncertain);
            border-color: var(--color-uncertain);
        }
        
        /* Upload Area - Clean, Professional */
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.2s ease;
            background-color: var(--color-background);
        }
        
        .upload-area:hover {
            border-color: var(--color-primary);
            background-color: var(--color-surface);
        }
        
        .upload-area.drag-active {
            border-color: var(--color-primary);
            background-color: var(--color-surface);
        }
        
        .upload-area.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Loading Spinner - Industrial Style */
        .spinner {
            border: 3px solid var(--color-border);
            border-radius: 50%;
            border-top: 3px solid var(--color-primary);
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Buttons - Industrial, Confident */
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background-color: var(--color-primary-hover);
        }
        
        .btn-primary:disabled {
            background-color: var(--color-uncertain);
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: transparent;
            color: var(--color-primary);
            padding: 12px 24px;
            border: 2px solid var(--color-primary);
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-secondary:hover {
            background-color: var(--color-primary);
            color: white;
        }
        
        /* Cards - Clean, Professional */
        .card {
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Form Inputs - Industrial Style */
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
            background-color: var(--color-background);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 6px;
        }
        
        /* Table - Dense but Readable */
        .table-zebra tbody tr:nth-child(even) {
            background-color: var(--color-surface);
        }
        
        .table-header {
            background-color: var(--color-surface);
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Mobile Responsivity */
        @media (max-width: 768px) {
            .health-circle {
                width: 160px;
                height: 160px;
            }
            
            .health-circle .score-text {
                font-size: 2rem;
            }
            
            .card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-4xl mx-auto py-8 px-4">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ZENKENSA</h1>
            <p class="text-gray-600">AI Ë°®Èù¢Ê§úÊüª„Ç∑„Çπ„ÉÜ„É†</p>
        </header>
        
        <!-- Input Section: Inspector Info + Upload -->
        <section class="card mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label class="form-label">Ê§úÊüªÂì°Âêç (Inspector Name)</label>
                    <input type="text" id="inspectorName" class="form-input" placeholder="Ê§úÊüªÂì°Âêç„ÇíÂÖ•Âäõ">
                </div>
                <div>
                    <label class="form-label">„Éê„ÉÉ„ÉÅID (Batch ID)</label>
                    <input type="text" id="batchId" class="form-input" placeholder="„Éê„ÉÉ„ÉÅID„ÇíÂÖ•Âäõ">
                </div>
                <div>
                    <label class="form-label">Ë£ΩÂìÅË™¨Êòé (Product Description)</label>
                    <input type="text" id="productDescription" class="form-input" placeholder="Ë£ΩÂìÅË™¨Êòé„ÇíÂÖ•Âäõ">
                </div>
            </div>
            
            <!-- Upload Area -->
            <div id="uploadArea" class="upload-area">
                <input type="file" id="fileInput" class="hidden" accept="image/*" capture="environment">
                
                <!-- Upload Content -->
                <div id="uploadContent">
                    <div class="text-4xl mb-4">üì∑</div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">ÈáëÂ±ûË°®Èù¢„ÅÆËøëÊé•ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
                    <p class="text-gray-600 text-sm mb-4">Upload close-up industrial metal surface image</p>
                    <button id="uploadBtn" class="btn-primary">
                        <span>üìÅ</span>
                        <span>ÁîªÂÉè„ÇíÈÅ∏Êäû (Choose Image)</span>
                    </button>
                </div>
                
                <!-- Loading Content -->
                <div id="loadingContent" class="hidden">
                    <div class="spinner mx-auto mb-4"></div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Ëß£Êûê‰∏≠...</h3>
                    <p class="text-gray-600 text-sm">Analyzing surface...</p>
                </div>
            </div>
        </section>
        
        <!-- Result Section -->
        <section id="resultSection" class="hidden space-y-6">
            <!-- Status Card -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Ê§úÊüªÁµêÊûú (Inspection Result)</h3>
                    <div id="statusBadge" class="status-badge"></div>
                </div>
                <div id="explanationText" class="text-gray-600 text-sm mb-3"></div>
                <div id="warningText" class="text-amber-600 text-sm hidden"></div>
            </div>
            
            <!-- Detailed Results -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Health Score -->
                <div class="card flex flex-col items-center">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">ÂÅ•ÂÖ®ÊÄß„Çπ„Ç≥„Ç¢</h3>
                    <div id="healthCircle" class="health-circle">
                        <div class="responsibility-note">ÂèÇËÄÉÊåáÊ®ôÔºàËá™ÂãïÂà§ÂÆöÔºâ</div>
                        <div class="score-text">0%</div>
                        <div class="score-label">Health Score</div>
                    </div>
                </div>
                
                <!-- Metrics & Actions -->
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Ê§úÊüª„É°„Éà„É™„ÇØ„Çπ (Inspection Metrics)</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600 text-sm">ÈáëÂ±û„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ (Metal Validation)</span>
                            <span id="metalScore" class="font-semibold text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-200">
                            <span class="text-gray-600 text-sm">Ê¨†Èô•‰ø°È†ºÂ∫¶ (Defect Confidence)</span>
                            <span id="defectScore" class="font-semibold text-gray-900">-</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-gray-600 text-sm">Ê§úÊüªID (Inspection ID)</span>
                            <span id="inspectionId" class="font-mono text-sm text-gray-900">-</span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-6 space-y-3">
                        <button id="downloadReportBtn" class="btn-primary w-full">
                            <span>üìÑ</span>
                            <span>Ê§úÊüª„É¨„Éù„Éº„Éà„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ (Download Report)</span>
                        </button>
                        <button id="newInspectionBtn" class="btn-secondary w-full">
                            <span>üîÑ</span>
                            <span>Êñ∞Ë¶èÊ§úÊüª (New Inspection)</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Inspection History Table -->
        <section class="card mt-8">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Ê§úÊüªÂ±•Ê≠¥ (Inspection History)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3 text-left">Êó•ÊôÇ (Timestamp)</th>
                            <th class="px-4 py-3 text-left">Ê§úÊüªÂì° (Inspector)</th>
                            <th class="px-4 py-3 text-left">„Éê„ÉÉ„ÉÅ (Batch)</th>
                            <th class="px-4 py-3 text-left">Âà§ÂÆö (Status)</th>
                            <th class="px-4 py-3 text-left">„Çπ„Ç≥„Ç¢ (Score)</th>
                            <th class="px-4 py-3 text-left">Ê¨†Èô•Êï∞ (Defects)</th>
                            <th class="px-4 py-3 text-left">„É¨„Éù„Éº„Éà (Report)</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="table-zebra">
                        <!-- History rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        let currentInspectionId = null;
        
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadContent = document.getElementById('uploadContent');
        const loadingContent = document.getElementById('loadingContent');
        const resultSection = document.getElementById('resultSection');
        
        // Drag and Drop Handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-active');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-active');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        // Click Handlers
        uploadBtn.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('click', (e) => {
            if (e.target.id !== 'uploadBtn') {
                fileInput.click();
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
        
        // Action Button Handlers
        document.getElementById('newInspectionBtn').addEventListener('click', () => {
            resetForm();
        });
        
        document.getElementById('downloadReportBtn').addEventListener('click', () => {
            if (currentInspectionId) {
                window.open(`/report/${currentInspectionId}`, '_blank');
            }
        });
        
        // File Upload Handler
        function handleFileUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Please upload an image file)');
                return;
            }
            
            // Show loading state
            uploadContent.classList.add('hidden');
            loadingContent.classList.remove('hidden');
            uploadArea.classList.add('disabled');
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            
            // Send to API
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ê§úÊüª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ (Inspection failed. Please try again.)');
                resetForm();
            });
        }
        
        // Display Results
        function displayResults(data) {
            // Hide loading, show results
            uploadContent.classList.remove('hidden');
            loadingContent.classList.add('hidden');
            uploadArea.classList.remove('disabled');
            resultSection.classList.remove('hidden');
            
            // Store inspection ID
            currentInspectionId = data.inspection_id || generateInspectionId();
            
            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            const explanationText = document.getElementById('explanationText');
            const warningText = document.getElementById('warningText');
            const healthCircle = document.getElementById('healthCircle');
            const scoreText = healthCircle.querySelector('.score-text');
            
            // Reset classes
            healthCircle.className = 'health-circle';
            statusBadge.className = 'status-badge';
            
            // Handle different statuses
            if (data.status === 'INVALID_INPUT') {
                statusBadge.textContent = 'ÁÑ°Âäπ / INVALID';
                statusBadge.classList.add('invalid');
                healthCircle.classList.add('invalid');
                explanationText.textContent = data.message || 'Áî£Ê•≠Áî®ÈáëÂ±ûË°®Èù¢„ÅÆÊ§úÊüªÂèØËÉΩ„Å™ÁîªÂÉè„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
                warningText.textContent = 'ÊòéÁ¢∫„Å™ÈáëÂ±ûË°®Èù¢ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                warningText.classList.remove('hidden');
                scoreText.textContent = 'N/A';
                
                document.getElementById('defectScore').textContent = 'N/A';
                document.getElementById('metalScore').textContent = (data.metal_validation_score * 100).toFixed(1) + '%';
                
            } else if (data.status === 'UNCERTAIN') {
                statusBadge.textContent = 'Âà§ÂÆö‰øùÁïô / UNCERTAIN';
                statusBadge.classList.add('uncertain');
                healthCircle.classList.add('uncertain');
                explanationText.textContent = data.message || 'Ë°®Èù¢„Åå‰∏çÊòéÁ¢∫„Åß„Åô„ÄÇ„Çà„ÇäËâØ„ÅÑÁÖßÊòé„ÅßÂÜçÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                warningText.textContent = 'ÂÜçÊíÆÂΩ±„Åæ„Åü„ÅØÊãÖÂΩìËÄÖÁ¢∫Ë™ç„ÇíÊé®Â•®„Åó„Åæ„Åô (Retake or supervisor confirmation recommended)';
                warningText.classList.remove('hidden');
                scoreText.textContent = 'N/A';
                
                document.getElementById('metalScore').textContent = (data.metal_validation_score * 100).toFixed(1) + '%';
                document.getElementById('defectScore').textContent = (data.defect_score * 100).toFixed(1) + '%';
                
            } else {
                // Valid inspection (PASS/FAIL)
                const statusText = data.status === 'PASS' ? 'ÂêàÊ†º / PASS' : '‰∏çÂêàÊ†º / FAIL';
                statusBadge.textContent = statusText;
                explanationText.textContent = data.explanation || '';
                warningText.classList.add('hidden');
                
                if (data.status === 'PASS') {
                    statusBadge.classList.add('pass');
                    healthCircle.classList.add('pass');
                    if (!data.explanation) {
                        explanationText.textContent = 'Ë°®Èù¢„ÅØ„ÇØ„É™„Éº„É≥„Åß„ÄÅÊúâÊÑè„Å™Ê¨†Èô•„Éë„Çø„Éº„É≥„ÅØË¶ã„Çâ„Çå„Åæ„Åõ„Çì„ÄÇ';
                    }
                } else {
                    statusBadge.classList.add('fail');
                    healthCircle.classList.add('fail');
                    if (!data.explanation) {
                        explanationText.textContent = 'Ë°®Èù¢„Å´Ë®±ÂÆπÁØÑÂõ≤„ÇíË∂Ö„Åà„ÇãÊ¨†Èô•„Éë„Çø„Éº„É≥„ÅåË¶ã„Çâ„Çå„Åæ„Åô„ÄÇ';
                    }
                }
                
                // Update scores with null safety
                const healthScore = data.health_score !== null ? data.health_score : 0;
                const metalScore = data.metal_validation_score !== null ? data.metal_validation_score : 0;
                const defectScore = data.defect_score !== null ? data.defect_score : 0;
                
                scoreText.textContent = Math.round(healthScore) + '%';
                document.getElementById('metalScore').textContent = (metalScore * 100).toFixed(1) + '%';
                document.getElementById('defectScore').textContent = (defectScore * 100).toFixed(1) + '%';
            }
            
            // Update inspection ID
            document.getElementById('inspectionId').textContent = currentInspectionId;
            
            // Load history
            loadInspectionHistory();
        }
        
        // Reset Form
        function resetForm() {
            uploadContent.classList.remove('hidden');
            loadingContent.classList.add('hidden');
            uploadArea.classList.remove('disabled');
            resultSection.classList.add('hidden');
            fileInput.value = '';
            currentInspectionId = null;
        }
        
        // Generate Inspection ID
        function generateInspectionId() {
            return 'INS-' + Date.now().toString(36).toUpperCase();
        }
        
        // Load Inspection History
        function loadInspectionHistory() {
            // This would typically fetch from an API endpoint
            const tbody = document.getElementById('historyTableBody');
            // tbody.innerHTML = ''; // Clear existing history
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadInspectionHistory();
        });
    </script>
</body>
</html>
